# ν¬μΈνΈ μ λ¦½ μ• λλ” λ¬Έμ  λ””λ²„κΉ… κ°€μ΄λ“

## λ¬Έμ  μƒν™©
- μ£Όλ¬Έλ²νΈ: ORDER_1761870219344_3907
- κ²°μ μΌ: 2025λ…„ 10μ›” 31μΌ μ¤μ „ 09:24
- μƒν’: νΌν”μ•„μΌλλ“ μ•„ν¬λ¦΄ ν† νΌ ν¬ν† ν”„λ΅­ x7
- κ²°μ  κΈμ•΅: β‚©54,600μ›
- **λ¬Έμ **: ν¬μΈνΈκ°€ 0Pλ΅ ν‘μ‹λ¨ (μ λ¦½λμ§€ μ•μ)

---

## μν–‰ν• μ‘μ—… β…

### 1. ν¬μΈνΈ μ λ¦½ λ΅μ§μ— μƒμ„Έ λ΅κΉ… μ¶”κ°€

**νμΌ**: `pages/api/payments/confirm.js`

#### μ¶”κ°€λ λ΅κ·Έ (μ΄ 20κ° λ΅κ·Έ ν¬μΈνΈ)

```javascript
// 1. ν¬μΈνΈ μ λ¦½ ν”„λ΅μ„Έμ¤ μ‹μ‘
π’° [ν¬μΈνΈ μ λ¦½] isOrder=true, orderId=...
π’° [ν¬μΈνΈ μ λ¦½ μ‹μ‘] userId=X, allPayments=Yκ±΄

// 2. Neon DB μ—°κ²° λ° νΈλμ­μ…
π’° [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ‹μ‘
π’° [ν¬μΈνΈ] Neon DB μ‚¬μ©μ μ΅°ν κ²°κ³Ό: Xκ±΄
π’° [ν¬μΈνΈ] μ‚¬μ©μ μ •λ³΄: id=X, name=XXX, ν„μ¬ ν¬μΈνΈ=XP

// 3. κ° paymentλ³„ ν¬μΈνΈ κ³„μ‚°
π’° [ν¬μΈνΈ] Xκ° paymentμ— λ€ν•΄ ν¬μΈνΈ μ λ¦½ μ‹μ‘
π’° [ν¬μΈνΈ] payment_id=X: subtotal=Xμ›, category=XXX
π’° [ν¬μΈνΈ] payment_id=X: XP μ λ¦½ μμ • (μ”μ•΅: XP)
β… [ν¬μΈνΈ] payment_id=X XP μ λ¦½ μ™„λ£ (user_points insert_id=X)

// 4. Neon users ν…μ΄λΈ” μ—…λ°μ΄νΈ
π’° [ν¬μΈνΈ] Neon users ν…μ΄λΈ” μ—…λ°μ΄νΈ μ‹μ‘: XP
β… [ν¬μΈνΈ] μ΄ XP μ λ¦½ μ™„λ£ (μ‚¬μ©μ X, μµμΆ… μ”μ•΅: XP)

// 5. νΈλμ­μ… μ»¤λ°‹
π’° [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ»¤λ°‹ μ‹λ„
β… [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ»¤λ°‹ μ™„λ£
π’° [ν¬μΈνΈ] Neon DB μ—°κ²° μΆ…λ£
```

#### μ—λ¬ λ΅κ·Έ

```javascript
// userId μ—†μ
β [ν¬μΈνΈ μ λ¦½] userIdκ°€ μ—†μµλ‹λ‹¤! orderId=...
β [ν¬μΈνΈ μ λ¦½] ν¬μΈνΈ μ λ¦½ λ¶κ°€ - userId ν™•μΈ ν•„μ”

// μ‚¬μ©μ μ •λ³΄ μ—†μ
β [ν¬μΈνΈ] Neon DBμ— user_id=Xμ— ν•΄λ‹Ήν•λ” μ‚¬μ©μκ°€ μ—†μµλ‹λ‹¤!
β [ν¬μΈνΈ] ν¬μΈνΈ μ λ¦½ λ¶κ°€ - μ‚¬μ©μ λ°μ΄ν„° ν™•μΈ ν•„μ”

// ν¬μΈνΈ 0P
β οΈ [ν¬μΈνΈ] payment_id=X: μ λ¦½ ν¬μΈνΈ 0P (subtotal=X)
β οΈ [ν¬μΈνΈ] μ λ¦½ν•  ν¬μΈνΈκ°€ 0Pμ…λ‹λ‹¤

// κ°λ³„ payment μ λ¦½ μ‹¤ν¨
β [ν¬μΈνΈ] payment_id=X μ λ¦½ μ‹¤ν¨: [μ—λ¬ λ©”μ‹μ§€]
β [ν¬μΈνΈ] μ—λ¬ μƒμ„Έ: [μ¤νƒ νΈλ μ΄μ¤]

// μ „μ²΄ ν¬μΈνΈ μ λ¦½ μ‹¤ν¨
β [ν¬μΈνΈ/μ•λ¦Ό] μ²λ¦¬ μ‹¤ν¨: [μ—λ¬ λ©”μ‹μ§€]
β [ν¬μΈνΈ] μ—λ¬ μ¤νƒ: [μ¤νƒ νΈλ μ΄μ¤]
β [ν¬μΈνΈ] μ—λ¬ νƒ€μ…: [μ—λ¬ νƒ€μ…]
β [ν¬μΈνΈ] μ—λ¬ λ©”μ‹μ§€: [μ—λ¬ λ©”μ‹μ§€]
β οΈ [ν¬μΈνΈ] Neon DB νΈλμ­μ… λ΅¤λ°± μ™„λ£
β οΈ [ν¬μΈνΈ] ν¬μΈνΈ μ λ¦½ μ‹¤ν¨ν–μ§€λ§ κ²°μ λ” μ„±κ³µ μ²λ¦¬λ¨
```

---

## λ‹¤μ λ‹¨κ³„: λ΅κ·Έ ν™•μΈ

### 1. μ„λ²„ λ΅κ·Έ ν™•μΈ

κ²°μ  μ™„λ£ μ‹ μ„λ²„ μ½μ†”μ—μ„ λ‹¤μ λ΅κ·Έλ¥Ό ν™•μΈ:

**λ΅μ»¬ κ°λ°**:
```bash
npm run dev
# λλ”
vercel dev
```

**Vercel λ°°ν¬**:
1. Vercel Dashboard μ ‘μ†
2. ν”„λ΅μ νΈ μ„ νƒ
3. "Logs" νƒ­ ν΄λ¦­
4. μ‹κ°„λ€ ν•„ν„°λ§: 2025λ…„ 10μ›” 31μΌ 09:24 μ „ν›„

### 2. μμƒ μ‹λ‚λ¦¬μ¤λ³„ λ€μ‘

#### μ‹λ‚λ¦¬μ¤ A: userIdκ°€ μ—†μ
```
β [ν¬μΈνΈ μ λ¦½] userIdκ°€ μ—†μµλ‹λ‹¤! orderId=ORDER_1761870219344_3907
```

**μ›μΈ**: μ£Όλ¬Έ μƒμ„± μ‹ user_idκ°€ μ €μ¥λμ§€ μ•μ

**ν™•μΈ λ°©λ²•**:
```sql
-- PlanetScale MySQL
SELECT id, user_id, gateway_transaction_id, created_at
FROM payments
WHERE gateway_transaction_id = 'ORDER_1761870219344_3907';
```

**ν•΄κ²°μ±…**:
```sql
-- user_id μ—…λ°μ΄νΈ (μ‹¤μ  μ‚¬μ©μ IDλ΅ λ³€κ²½)
UPDATE payments
SET user_id = <μ‹¤μ _μ‚¬μ©μ_ID>
WHERE gateway_transaction_id = 'ORDER_1761870219344_3907';
```

---

#### μ‹λ‚λ¦¬μ¤ B: Neon DBμ— μ‚¬μ©μ μ—†μ
```
π’° [ν¬μΈνΈ] Neon DB μ‚¬μ©μ μ΅°ν κ²°κ³Ό: 0κ±΄
β [ν¬μΈνΈ] Neon DBμ— user_id=Xμ— ν•΄λ‹Ήν•λ” μ‚¬μ©μκ°€ μ—†μµλ‹λ‹¤!
```

**μ›μΈ**: Neon PostgreSQL users ν…μ΄λΈ”μ— ν•΄λ‹Ή user_idκ°€ μ—†μ

**ν™•μΈ λ°©λ²•**:
```sql
-- Neon PostgreSQL
SELECT id, name, email, total_points
FROM users
WHERE id = <user_id>;
```

**ν•΄κ²°μ±…**: μ‚¬μ©μ λ°μ΄ν„°κ°€ μλ”μ§€ ν™•μΈ, μ—†μΌλ©΄ νμ›κ°€μ… ν•„μ”

---

#### μ‹λ‚λ¦¬μ¤ C: subtotalμ΄ 0μ›
```
π’° [ν¬μΈνΈ] payment_id=X: subtotal=0μ›, category=νμ—…
β οΈ [ν¬μΈνΈ] payment_id=X: μ λ¦½ ν¬μΈνΈ 0P (subtotal=0)
```

**μ›μΈ**: payments.notesμ— subtotal μ •λ³΄κ°€ μ—†κ±°λ‚ 0μ›

**ν™•μΈ λ°©λ²•**:
```sql
-- PlanetScale MySQL
SELECT id, notes
FROM payments
WHERE gateway_transaction_id = 'ORDER_1761870219344_3907';
```

notes κ°’ μμ‹:
```json
{
  "category": "νμ—…",
  "items": [...],
  "subtotal": 54600,    // <-- μ΄ κ°’μ΄ μμ–΄μ•Ό ν•¨
  "deliveryFee": 0,
  "couponDiscount": 0,
  "pointsUsed": 0
}
```

**ν•΄κ²°μ±…**: notes.subtotal κ°’ ν™•μΈ, μ—†μΌλ©΄ μλ™μΌλ΅ ν¬μΈνΈ μ λ¦½

---

#### μ‹λ‚λ¦¬μ¤ D: DB μ—°κ²° μ‹¤ν¨
```
β [ν¬μΈνΈ/μ•λ¦Ό] μ²λ¦¬ μ‹¤ν¨: Error: connect ETIMEDOUT
β [ν¬μΈνΈ] μ—λ¬ νƒ€μ…: Error
```

**μ›μΈ**: Neon PostgreSQL μ—°κ²° μ‹¤ν¨

**ν™•μΈ λ°©λ²•**:
```bash
# ν™κ²½ λ³€μ ν™•μΈ
echo $POSTGRES_DATABASE_URL
echo $DATABASE_URL
```

**ν•΄κ²°μ±…**:
- `.env` νμΌμ— Neon DB URL ν™•μΈ
- Neon Dashboardμ—μ„ DB μƒνƒ ν™•μΈ
- IP ν™”μ΄νΈλ¦¬μ¤νΈ μ„¤μ • ν™•μΈ

---

#### μ‹λ‚λ¦¬μ¤ E: user_points ν…μ΄λΈ” INSERT μ‹¤ν¨
```
π’° [ν¬μΈνΈ] payment_id=123: 1092P μ λ¦½ μμ • (μ”μ•΅: 1092P)
β [ν¬μΈνΈ] payment_id=123 μ λ¦½ μ‹¤ν¨: Error: Table 'user_points' doesn't exist
```

**μ›μΈ**: PlanetScale MySQLμ— user_points ν…μ΄λΈ”μ΄ μ—†μ

**ν™•μΈ λ°©λ²•**:
```sql
-- PlanetScale MySQL
SHOW TABLES LIKE 'user_points';
DESC user_points;
```

**ν•΄κ²°μ±…**: user_points ν…μ΄λΈ” μƒμ„± μ¤ν¬λ¦½νΈ μ‹¤ν–‰

---

## μλ™ ν¬μΈνΈ μ λ¦½ λ°©λ²•

ν„μ¬ μ£Όλ¬Έ (ORDER_1761870219344_3907)μ— λ€ν• ν¬μΈνΈλ¥Ό μλ™μΌλ΅ μ λ¦½:

### 1. ν•„μ”ν• μ •λ³΄ μ΅°ν

```sql
-- PlanetScale MySQL: payment μ •λ³΄ μ΅°ν
SELECT id, user_id, amount, notes
FROM payments
WHERE gateway_transaction_id = 'ORDER_1761870219344_3907';
```

κ²°κ³Ό μμ‹:
```
id: 123
user_id: 1
amount: 54600
notes: {"subtotal": 54600, "deliveryFee": 0, ...}
```

### 2. ν¬μΈνΈ κ³„μ‚°

```javascript
subtotal = 54600μ›
pointsToEarn = Math.floor(54600 * 0.02) = 1092P
```

### 3. user_points ν…μ΄λΈ”μ— INSERT

```sql
-- PlanetScale MySQL
INSERT INTO user_points (
  user_id,
  points,
  point_type,
  reason,
  related_order_id,
  balance_after,
  expires_at,
  created_at
) VALUES (
  1,                                          -- user_id (μ‹¤μ  κ°’μΌλ΅ λ³€κ²½)
  1092,                                       -- μ λ¦½ ν¬μΈνΈ
  'earn',                                     -- μ λ¦½ νƒ€μ…
  'μ£Όλ¬Έ μ λ¦½ (payment_id: 123, μΉ΄ν…κ³ λ¦¬: νμ—…)', -- μ‚¬μ 
  '123',                                      -- payment_id
  1092,                                       -- μ”μ•΅ (κΈ°μ΅΄ ν¬μΈνΈ + μ λ¦½ ν¬μΈνΈ)
  DATE_ADD(NOW(), INTERVAL 1 YEAR),          -- λ§λ£μΌ (1λ…„ ν›„)
  NOW()
);
```

### 4. Neon users ν…μ΄λΈ” μ—…λ°μ΄νΈ

```sql
-- Neon PostgreSQL: ν„μ¬ ν¬μΈνΈ μ΅°ν
SELECT total_points FROM users WHERE id = 1;

-- ν¬μΈνΈ μ—…λ°μ΄νΈ (κΈ°μ΅΄ ν¬μΈνΈ + 1092)
UPDATE users
SET total_points = total_points + 1092
WHERE id = 1;
```

---

## ν¬μΈνΈ μ λ¦½ μ²΄ν¬λ¦¬μ¤νΈ

### κ²°μ  μ‹ ν™•μΈμ‚¬ν•­

- [ ] orderIdκ°€ `ORDER_`λ΅ μ‹μ‘ν•λ”μ§€ ν™•μΈ (isOrder = true)
- [ ] userIdκ°€ μ΅΄μ¬ν•λ”μ§€ ν™•μΈ (payments.user_id)
- [ ] Neon DBμ— ν•΄λ‹Ή user_idκ°€ μλ”μ§€ ν™•μΈ
- [ ] payments.notesμ— subtotal κ°’μ΄ μλ”μ§€ ν™•μΈ
- [ ] subtotal > 0μΈμ§€ ν™•μΈ
- [ ] ν¬μΈνΈ κ³„μ‚°: Math.floor(subtotal * 0.02)
- [ ] user_points ν…μ΄λΈ” INSERT μ„±κ³µ
- [ ] Neon users.total_points μ—…λ°μ΄νΈ μ„±κ³µ

### μ„λ²„ λ΅κ·Έ ν™•μΈμ‚¬ν•­

- [ ] `π’° [ν¬μΈνΈ μ λ¦½ μ‹μ‘]` λ΅κ·Έ ν™•μΈ
- [ ] `π’° [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ‹μ‘` ν™•μΈ
- [ ] `π’° [ν¬μΈνΈ] μ‚¬μ©μ μ •λ³΄: ...` λ΅κ·Έ ν™•μΈ
- [ ] `π’° [ν¬μΈνΈ] payment_id=X: XP μ λ¦½ μμ •` λ΅κ·Έ ν™•μΈ
- [ ] `β… [ν¬μΈνΈ] payment_id=X XP μ λ¦½ μ™„λ£` ν™•μΈ
- [ ] `β… [ν¬μΈνΈ] μ΄ XP μ λ¦½ μ™„λ£` ν™•μΈ
- [ ] `β… [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ»¤λ°‹ μ™„λ£` ν™•μΈ
- [ ] μ—λ¬ λ΅κ·Έ μ—†μ ν™•μΈ

---

## ν…μ¤νΈ λ°©λ²•

### 1. μƒ μ£Όλ¬Έ μƒμ„± ν›„ ν¬μΈνΈ μ λ¦½ ν™•μΈ

1. μƒλ΅μ΄ μƒν’ μ£Όλ¬Έ
2. κ²°μ  μ™„λ£
3. μ„λ²„ λ΅κ·Έ ν™•μΈ
4. MyPage β†’ ν¬μΈνΈ νƒ­μ—μ„ ν™•μΈ
5. Neon DB users ν…μ΄λΈ”μ—μ„ total_points ν™•μΈ
6. PlanetScale user_points ν…μ΄λΈ”μ—μ„ λ μ½”λ“ ν™•μΈ

### 2. λ΅κ·Έ ν¨ν„΄ λ¶„μ„

**μ •μƒ μΌ€μ΄μ¤**:
```
π’° [ν¬μΈνΈ μ λ¦½ μ‹μ‘] userId=1, allPayments=1κ±΄
π’° [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ‹μ‘
π’° [ν¬μΈνΈ] Neon DB μ‚¬μ©μ μ΅°ν κ²°κ³Ό: 1κ±΄
π’° [ν¬μΈνΈ] μ‚¬μ©μ μ •λ³΄: id=1, name=ν™κΈΈλ™, ν„μ¬ ν¬μΈνΈ=0P
π’° [ν¬μΈνΈ] 1κ° paymentμ— λ€ν•΄ ν¬μΈνΈ μ λ¦½ μ‹μ‘
π’° [ν¬μΈνΈ] payment_id=123: subtotal=54600μ›, category=νμ—…
π’° [ν¬μΈνΈ] payment_id=123: 1092P μ λ¦½ μμ • (μ”μ•΅: 1092P)
β… [ν¬μΈνΈ] payment_id=123 1092P μ λ¦½ μ™„λ£ (user_points insert_id=456)
π’° [ν¬μΈνΈ] Neon users ν…μ΄λΈ” μ—…λ°μ΄νΈ μ‹μ‘: 1092P
β… [ν¬μΈνΈ] μ΄ 1092P μ λ¦½ μ™„λ£ (μ‚¬μ©μ 1, μµμΆ… μ”μ•΅: 1092P)
π’° [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ»¤λ°‹ μ‹λ„
β… [ν¬μΈνΈ] Neon DB νΈλμ­μ… μ»¤λ°‹ μ™„λ£
π’° [ν¬μΈνΈ] Neon DB μ—°κ²° μΆ…λ£
```

---

## κ΄€λ ¨ νμΌ

- `pages/api/payments/confirm.js`: ν¬μΈνΈ μ λ¦½ λ΅μ§
- `pages/api/user/points.js`: ν¬μΈνΈ λ‚΄μ—­ μ΅°ν API
- `components/pages/RewardsPage.tsx`: ν¬μΈνΈ νμ΄μ§€ UI

---

## λ‹¤μ μ‘μ—…

1. **μ„λ²„ λ΅κ·Έ ν™•μΈ**: μ„μ λ΅κ·Έ ν¨ν„΄ μ¤‘ μ–΄λ μ‹λ‚λ¦¬μ¤μΈμ§€ ν™•μΈ
2. **μ›μΈ νμ•…**: μ‹λ‚λ¦¬μ¤λ³„ ν•΄κ²°μ±… μ μ©
3. **μλ™ μ λ¦½**: ν•„μ”μ‹ SQLλ΅ μλ™ ν¬μΈνΈ μ λ¦½
4. **ν…μ¤νΈ**: μƒ μ£Όλ¬ΈμΌλ΅ ν¬μΈνΈ μ λ¦½ ν…μ¤νΈ

---

## λ¬Έμ

λ΅κ·Έλ¥Ό ν™•μΈν•κ³  μ–΄λ–¤ μ—λ¬κ°€ λ°μƒν–λ”μ§€ κ³µμ ν•΄μ£Όμ‹λ©΄ μ •ν™•ν• ν•΄κ²°μ±…μ„ μ μ‹ν•κ² μµλ‹λ‹¤.
