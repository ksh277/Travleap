# 스마트 쿠폰 시스템 - 테스트 모드 (채널톡 없는 버전)

> 카카오 채널/카카오싱크 연동 없이 웹만으로 전체 쿠폰 시스템 테스트

---

## 1. 개념: "핵심 로직" vs "카카오 래핑"

### 핵심 로직 (먼저 구현/테스트)
- 회원가입/로그인
- 쿠폰 발급 (`user_coupons` 생성)
- 쿠폰 사용 (검증 + 할인 계산 + USED 처리)
- 리뷰 작성 + 포인트 적립
- 통계/정산

### 카카오 연동 (나중에 래핑)
- 카카오싱크 로그인으로 유저 생성
- 알림톡으로 링크 보내기

👉 **지금 단계에서는 핵심 로직을 전부 "일반 웹 화면"으로 테스트하고,**
**나중에 카카오는 `/auth/kakao/callback` → "일반 로그인 성공 후 리다이렉트" 래핑만 해주면 됨.**

---

## 2. 유저 쪽 테스트 플로우 (카카오 없이)

### (1) 일반 회원가입/로그인 화면

| 경로 | 설명 |
|------|------|
| `/signup` | 이메일/비번으로 회원가입 |
| `/login` | 로그인 (일반 유저/파트너 모두 여기서) |

- 일반 유저 로그인 → `/` (홈)
- **파트너 계정 로그인 → `/partner/dashboard` (파트너 대시보드)**
- 관리자 로그인 → `/admin`

### (2) 쿠폰 발급 테스트

**별도 테스트 페이지 필요 없음!**

기존 `/c/[code]` 페이지 사용:
- 경로: `/c/SHINAN2025`
- 로그인한 사용자 대상으로 쿠폰 발급
- 발급 후 쿠폰 코드와 QR 표시
- 사용 가능한 가맹점 목록 표시

```
[신안 스마트 쿠폰]
- 15% 할인 (최대 10,000원)
- 유효기간: 2025.12.31까지

[ 쿠폰 발급받기 ] 버튼

[사용 가능 매장]
- 신안 바다회관 (음식점) - 1.2km
- 퍼플섬 카페 (카페) - 2.5km
...
```

### (3) 쿠폰 사용 가능 가맹점 보기

**별도 테스트 페이지 필요 없음!**

기존 가맹점/매장 페이지에 **쿠폰 필터 기능 추가**:

**UI 요구사항:**
```
[가맹점 목록 페이지]

필터 옵션:
☑ 쿠폰 사용 가능한 매장만 보기

[매장 카드]
┌─────────────────────────────┐
│ 🏪 신안 바다회관            │
│ 음식점 · 1.2km              │
│ ┌──────────┐                │
│ │ 🎫 쿠폰  │ ← 쿠폰 뱃지    │
│ │ 15% 할인 │                │
│ └──────────┘                │
└─────────────────────────────┘
```

**필터 조건:**
- `partners.is_coupon_partner = TRUE`
- `partners.status = 'APPROVED'`
- 쿠폰의 `target_type(ALL / CATEGORY / SPECIFIC)`에 맞는 파트너만

---

## 3. 파트너 쪽 테스트 플로우

### (1) 파트너 로그인

**별도 로그인 페이지 필요 없음!**

기존 `/login` 페이지 사용:
- 파트너 계정(role='partner')으로 로그인
- 로그인 성공 시 자동으로 `/partner/dashboard`로 이동

### (2) 파트너 대시보드

**경로:** `/partner/dashboard` 또는 `/partner/coupon`

**기능:**
- 쿠폰 스캔/입력 탭
- 사용 내역 탭
- 설정 탭

### (3) 쿠폰 스캐너

**경로:** `/partner/coupon` (기존 구현됨)

**화면:**
```
[쿠폰 코드 입력]
[           ]  (ABC123XY 직접 입력 또는 QR 스캔)
[ 조회하기 ]
```

**조회하기 누르면 서버에서 검증:**
1. 쿠폰 존재 여부
2. 유효기간 OK?
3. 이미 사용됨 아닐 것
4. 현재 파트너가 `APPROVED`?
5. `is_coupon_partner = TRUE`?
6. `target_type` 조건 충족?

**조건 안 맞으면:**
- "이 가맹점은 쿠폰 사용이 불가능합니다." 에러

**조건 맞으면:**
```
주문 금액을 입력하세요.
[   32,000   ] 원
[ 할인 계산하기 ]

↓

주문 금액: 32,000원
할인 금액: 4,800원
최종 결제금액: 27,200원

[ 사용 완료 처리 ]
```

**"사용 완료 처리" 시:**
- `user_coupons.status = 'USED'`
- `user_coupons.used_partner_id`, `order_amount`, `discount_amount`, `final_amount` 저장
- `partners.total_coupon_usage` / `total_discount_given` 업데이트

---

## 4. 관리자 - 파트너 쿠폰 ON/OFF 관리

### 관리자 페이지에서 파트너 관리

**경로:** `/admin` → 파트너 관리

**파트너 추가/수정 폼:**
```
┌─────────────────────────────────────┐
│ 파트너 정보 수정                     │
├─────────────────────────────────────┤
│ 상호명: [신안 바다회관        ]     │
│ 카테고리: [음식점 ▼]                │
│ 주소: [전라남도 신안군...     ]     │
│ 전화번호: [061-275-1234      ]     │
│ 상태: [승인됨 ▼]                    │
│                                     │
│ ─── 쿠폰 설정 ───                   │
│                                     │
│ 쿠폰 참여: [ON 🔘] / [OFF ○]        │ ← 핵심!
│                                     │
│ (ON일 때만 표시)                    │
│ 할인 타입: [퍼센트 ▼]               │
│ 할인율/금액: [15        ]           │
│ 최대 할인: [10000      ]원          │
│ 최소 주문: [30000      ]원          │
│                                     │
│ [ 저장 ]  [ 취소 ]                  │
└─────────────────────────────────────┘
```

**DB 필드:**
- `partners.is_coupon_partner` = TRUE/FALSE (쿠폰 ON/OFF)
- `partners.discount_type` = 'PERCENT' / 'AMOUNT'
- `partners.discount_value` = 할인율 또는 할인금액
- `partners.max_discount_amount` = 최대 할인액
- `partners.min_order_amount` = 최소 주문금액

---

## 5. 후기 + 포인트 테스트 (웹 전용)

### (1) 쿠폰 사용 후 리뷰 유도

쿠폰이 `USED`로 바뀌는 순간:
- `user_coupons.review_submitted = FALSE` (리뷰 대기 상태)

### (2) 웹에서 자동 모달

사용자 로그인 후 홈(`/`) 또는 마이페이지 접속 시:
- `/api/my/pending-reviews` 호출
- `review_submitted = FALSE`인 사용된 쿠폰이 있으면 모달 표시:

```
┌─────────────────────────────────────┐
│ 방문하신 OO카페는 어떠셨나요?        │
├─────────────────────────────────────┤
│                                     │
│ 별점: ★★★★★                        │
│                                     │
│ 후기:                               │
│ ┌─────────────────────────────────┐│
│ │                                 ││
│ │                                 ││
│ └─────────────────────────────────┘│
│                                     │
│ [ 작성하기 ]  [ 나중에 ]            │
└─────────────────────────────────────┘
```

**"작성하기" 시:**
- `coupon_reviews` 테이블 INSERT
- `user_coupons.review_submitted = TRUE`
- `user_coupons.review_points_awarded = 500`
- 유저 포인트 +500 적립

---

## 6. 페이지/API 체크리스트

### 페이지

| 경로 | 용도 | 상태 |
|------|------|------|
| `/signup` | 회원가입 | ✅ 있음 |
| `/login` | 로그인 (유저/파트너 공용) | ✅ 있음 |
| `/c/[code]` | 쿠폰 발급 + 매장 목록 | ✅ 있음 |
| `/stores` 또는 `/partners` | 가맹점 목록 (쿠폰 필터 추가 필요) | ⚠️ 필터 추가 필요 |
| `/my/coupons` | 내 쿠폰함 | ✅ 있음 |
| `/partner/dashboard` | 파트너 대시보드 | ⚠️ 확인 필요 |
| `/partner/coupon` | 쿠폰 스캐너 | ✅ 있음 |
| `/admin` | 관리자 페이지 (파트너 쿠폰 ON/OFF) | ⚠️ 토글 추가 필요 |

### API

| 경로 | 용도 | 상태 |
|------|------|------|
| `/api/coupon/claim` | 쿠폰 발급 | ✅ 있음 |
| `/api/coupon/partner/v2/validate` | 쿠폰 검증 | ✅ 있음 |
| `/api/coupon/partner/v2/use` | 쿠폰 사용 처리 | ✅ 있음 |
| `/api/stores` | 가맹점 목록 (쿠폰 필터) | ✅ 있음 |
| `/api/my/pending-reviews` | 대기 중인 리뷰 | ❌ 없음 |
| `/api/coupon/review` | 리뷰 작성 + 포인트 | ✅ 있음 |

---

## 7. 구현 필요 항목 (우선순위)

### 1순위: 필수
1. **가맹점 페이지에 쿠폰 필터 추가**
   - 쿠폰 뱃지 표시
   - "쿠폰 사용 가능" 필터 체크박스

2. **관리자 파트너 관리에 쿠폰 ON/OFF 토글**
   - 파트너 추가/수정 폼에 `is_coupon_partner` 토글
   - 할인 설정 필드 (ON일 때만)

3. **`/api/my/pending-reviews` API**
   - 리뷰 대기 중인 쿠폰 조회

4. **리뷰 모달**
   - 홈/마이페이지 접속 시 자동 팝업

### 2순위: 개선
5. **파트너 대시보드 `/partner/dashboard`**
   - 로그인 후 리다이렉트 확인

6. **QR 스캐너 카메라**
   - jsQR 라이브러리 연동

---

## 8. 플로우 다이어그램

```
[유저]
    │
    ▼
[/login] ──────────────────────────────┐
    │                                  │
    │ 일반 유저                        │ 파트너 계정
    ▼                                  ▼
[/c/SHINAN2025]                   [/partner/dashboard]
    │                                  │
    ▼                                  ▼
[쿠폰 발급]                       [/partner/coupon]
    │                                  │
    ▼                                  ▼
[/stores?filter=coupon]           [쿠폰 코드 입력]
    │                                  │
    │ 가맹점 방문                       │
    └──────────────┬───────────────────┘
                   ▼
            [쿠폰 사용 처리]
                   │
                   ▼
            [user_coupons.status = USED]
            [review_submitted = FALSE]
                   │
                   ▼
            [홈/마이페이지 접속]
                   │
                   ▼
            [리뷰 모달 자동 팝업]
                   │
                   ▼
            [리뷰 작성 → +500포인트]
```

---

## 9. 관리자 플로우

```
[관리자]
    │
    ▼
[/login] (admin 계정)
    │
    ▼
[/admin]
    │
    ▼
[파트너 관리]
    │
    ├─ 파트너 추가
    │   └─ 쿠폰 참여: ON/OFF 토글
    │
    └─ 파트너 수정
        └─ 쿠폰 참여: ON/OFF 토글
            └─ ON일 때: 할인 설정 입력
```

---

## 10. 나중에 카카오 연동 시

테스트 모드에서 만든 것들을 그대로 재사용:

| 테스트 모드 | 카카오 연동 시 |
|-------------|----------------|
| `/login` | `/auth/kakao/callback` → 동일 JWT 발급 |
| `/c/[code]` | 콜백에서 자동 쿠폰 발급 호출 |
| `/stores?filter=coupon` | 알림톡 버튼 링크로 사용 |
| `/partner/coupon` | 그대로 사용 |
| 리뷰 모달 | 알림톡으로 리뷰 페이지 링크 발송 |
