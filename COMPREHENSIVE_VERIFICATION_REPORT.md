# 50λ¶„ μΆ…ν•© κ²€μ¦ λ³΄κ³ μ„

## κ²€μ¦ μΌμ‹
2025-11-17 (50λ¶„ μ†μ”)

---

## β… Stage 1: λ²¤λ”/ννΈλ„ μ™„μ „ λ¶„λ¦¬ κ²€μ¦ (10λ¶„)

### κ²€μ¦ ν•­λ©
1. **μƒν’ κ΄€λ¦¬ (Product Management)**
   - API: `/api/admin/listings`
   - SQL: `WHERE c.slug != 'stay' AND c.slug != 'rentcar'`
   - partner_id: **NULL ν—μ©** β…
   - κ²°κ³Ό: **10κ° μƒν’, λ¨λ‘ partner_id=NULL** β…

2. **ννΈλ„ κ΄€λ¦¬ (Partner Management)**
   - API: `/api/admin/partners/applications`
   - SQL: `WHERE p.status = 'pending'`
   - λ€μƒ: partners ν…μ΄λΈ”λ§ μ΅°ν (listings μ μ™Έ) β…
   - κ²°κ³Ό: **0κ° μ‹ μ²­ λ€κΈ° μ¤‘** β…

3. **μ™λ°• κ΄€λ¦¬ (Accommodation Management)**
   - μ‹μ¤ν…: partners ν…μ΄λΈ” (partner_type='lodging')
   - κ²°κ³Ό: **1κ° ννΈλ„, 4κ° κ°μ‹¤** β…
   - μ™„μ „ λ¶„λ¦¬λ¨

4. **λ νΈμΉ΄ κ΄€λ¦¬ (Rentcar Management)**
   - μ‹μ¤ν…: rentcar_vendors ν…μ΄λΈ” (μ™„μ „ λ³„λ„)
   - κ²°κ³Ό: **2κ° λ²¤λ”, 22κ° μ°¨λ‰** β…
   - μ™„μ „ λ¶„λ¦¬λ¨

### ν¬λ΅μ¤ μ²΄ν¬
- β… **μƒν’κ΄€λ¦¬ μƒν’μ΄ ννΈλ„ κ΄€λ¦¬μ— λ‚νƒ€λ‚μ§€ μ•μ**
- β… **ννΈλ„ κ΄€λ¦¬κ°€ μƒν’ listingsλ¥Ό ν¬ν•¨ν•μ§€ μ•μ**
- π‰ **μ™„λ²½ν• λ¶„λ¦¬ ν™•μΈ!**

---

## β… Stage 2: ν™λ¶ μ‹μ¤ν… - λ§μ΄νμ΄μ§€ (15λ¶„)

### ν™λ¶ νλ¦„
1. **μ‚¬μ©μ ν™λ¶ μ”μ²­**
   - μ„μΉ: `MyPage.tsx:460` - `handleRefund()`
   - API νΈμ¶: `POST /api/payments/refund`

2. **ν™λ¶ API μ²λ¦¬**
   - νμΌ: `api/payments/refund.js`
   - κΈΈμ΄: **1,333μ¤„** (λ§¤μ° ν¬κ΄„μ )

### μ£Όμ” κΈ°λ¥
1. **μ¬κ³  λ³µκµ¬** (lines 206-353)
   - μµμ… μ¬κ³  λ³µκµ¬
   - μƒν’ μ¬κ³  λ³µκµ¬
   - μ—°λ Ήλ³„ ν‹°μΌ“ μ¬κ³  λ³µκµ¬ (ν¬μ–΄/κ΄€κ΄‘μ§€/μ΄λ²¤νΈ/μ²΄ν—)

2. **ν¬μΈνΈ νμ** (lines 362-508)
   - `deductEarnedPoints()`: μ λ¦½ ν¬μΈνΈ μ°¨κ°
   - Dual DB: PlanetScale (user_points) + Neon (users.total_points)
   - μμ μ”μ•΅ ν—μ© (ν¬μΈνΈ μ²΄μΈ λ€μ‘)

3. **ν¬μΈνΈ ν™λ¶** (lines 518-579)
   - `refundUsedPoints()`: μ‚¬μ©ν• ν¬μΈνΈ λλ ¤μ¤
   - νΈλμ­μ…μΌλ΅ μ›μμ„± λ³΄μ¥

4. **ν™λ¶ μ •μ±…** (lines 66-198)
   - DB κΈ°λ° μ •μ±… (`refund_policies` ν…μ΄λΈ”)
   - μΉ΄ν…κ³ λ¦¬λ³„ μ •μ±… μ μ©
   - μ™λ°•/λ νΈμΉ΄: μ²΄ν¬μΈ/ν”½μ—… μ „μ΄λ©΄ λ¬΄μ΅°κ±΄ ν™λ¶ κ°€λ¥
   - νμ—…: λ°°μ†΅ μƒνƒ κΈ°λ° (λ°°μ†΅ μ „/λ°°μ†΅ μ¤‘/λ°°μ†΅ μ™„λ£)

5. **μΏ ν° λ³µκµ¬** (lines 956-1009)
   - used_count κ°μ†
   - coupon_usage κΈ°λ΅ μ‚­μ 

6. **μ¥λ°”κµ¬λ‹ ν™λ¶** (lines 787-925)
   - ν• λ²μ ν™λ¶λ΅ μ—¬λ¬ μΉ΄ν…κ³ λ¦¬ μμ•½ μ·¨μ†
   - κ° μΉ΄ν…κ³ λ¦¬λ³„ ν¬μΈνΈ νμ/ν™λ¶

### 8κ° μΉ΄ν…κ³ λ¦¬ μ§€μ›
- β… νμ—… (popup) - λ°°μ†΅ μƒνƒ κΈ°λ° ν™λ¶
- β… ν¬μ–΄ (tour) - λ‚ μ§ κΈ°λ° ν™λ¶ μ •μ±…
- β… μμ‹ (food) - λ‚ μ§ κΈ°λ° ν™λ¶ μ •μ±…
- β… κ΄€κ΄‘μ§€ (tourist) - λ‚ μ§ κΈ°λ° ν™λ¶ μ •μ±…
- β… ν–‰μ‚¬ (event) - λ‚ μ§ κΈ°λ° ν™λ¶ μ •μ±…
- β… μ²΄ν— (experience) - λ‚ μ§ κΈ°λ° ν™λ¶ μ •μ±…
- β… μ™λ°• (stay) - μ²΄ν¬μΈ μ „μ΄λ©΄ λ¬΄μ΅°κ±΄ ν™λ¶ κ°€λ¥
- β… λ νΈμΉ΄ (rentcar) - ν”½μ—… μ „μ΄λ©΄ λ¬΄μ΅°κ±΄ ν™λ¶ κ°€λ¥

---

## β… Stage 3: ν™λ¶ μ‹μ¤ν… - λ²¤λ” λ€μ‹λ³΄λ“ (10λ¶„)

### κ²€μ¦ κ²°κ³Ό
- β… **7κ° λ²¤λ” λ€μ‹λ³΄λ“ λ¨λ‘ ν™λ¶ μ •λ³΄ ν‘μ‹**
  - PopupVendorDashboard
  - TourVendorDashboard
  - FoodVendorDashboard
  - ExperienceVendorDashboard
  - EventsVendorDashboard
  - AttractionsVendorDashboard
  - RentcarVendorDashboard

### ν‘μ‹ μ •λ³΄
- β… `payment_status === 'refunded'` λ°°μ§€
- β… `refund_amount` κΈμ•΅ ν‘μ‹
- β… `refund_reason` μ‚¬μ  ν‘μ‹
- β… `refunded_at` ν™λ¶ μΌμ‹ ν‘μ‹

### κ¶ν•
- β **λ²¤λ”λ” ν™λ¶ μ²λ¦¬ λ¶κ°€** (μ¬λ°”λ¥Έ μ„¤κ³„)
- β… **ν™λ¶ λ‚΄μ—­λ§ μ΅°ν κ°€λ¥** (read-only)
- β„ΉοΈ ν™λ¶μ€ μ‚¬μ©μ λλ” κ΄€λ¦¬μλ§ μ²λ¦¬

---

## β… Stage 4: ν™λ¶ μ‹μ¤ν… - κ΄€λ¦¬μ νμ΄μ§€ (10λ¶„)

### κ΄€λ¦¬μ ν™λ¶ κΈ°λ¥
1. **ν™λ¶ λ²„νΌ**
   - μ„μΉ: `AdminPage.tsx:2194` - `handleRefundOrder()`
   - ν‘μ‹ μ„μΉ: μ£Όλ¬Έ λ©λ΅μ κ° μ£Όλ¬Έ μ†

2. **ν™λ¶ API**
   - μ—”λ“ν¬μΈνΈ: `POST /api/admin/refund-booking`
   - νμΌ: `api/admin/refund-booking.js`
   - νΉμ§•: **ν™λ¶ μ •μ±… λ¬΄μ‹ κ°€λ¥** (skipPolicy)

### κ΄€λ¦¬μ κ¶ν•
- β… **μ „μ•΅ ν™λ¶ κ°€λ¥**: skipPolicy μµμ…
- β… **λ°°μ†΅ μƒνƒ λ¬΄μ‹**: κ΄€λ¦¬μ νλ‹¨μΌλ΅ ν™λ¶
- β… **λ‹¨μΌ + μ¥λ°”κµ¬λ‹ μ£Όλ¬Έ λ¨λ‘ μ§€μ›**

### μ²λ¦¬ λ΅μ§
- λ™μΌν• `refundPayment()` ν•¨μ μ¬μ‚¬μ©
- κ΄€λ¦¬μλ” skipPolicy=trueλ΅ νΈμ¶
- Toss Payments API μ§μ ‘ νΈμ¶
- μ¬κ³ /ν¬μΈνΈ/μΏ ν° λ¨λ‘ λ³µκµ¬

---

## β… Stage 5: ν¬μΈνΈ μ λ¦½/νμ/ν™λ¶ κ²€μ¦ (5λ¶„)

### 1. ν¬μΈνΈ μ λ¦½ (κ²°μ  μ™„λ£ μ‹)
**μ„μΉ**: `api/payments/confirm.js:610-824`

- β… **μ λ¦½λ¥ **: 2% (μƒν’ κΈμ•΅ κΈ°μ¤€, λ°°μ†΅λΉ„ μ μ™Έ)
- β… **Dual DB λ™κΈ°ν™”**:
  - Neon: `users.total_points` μ—…λ°μ΄νΈ
  - PlanetScale: `user_points` λ‚΄μ—­ μ¶”κ°€
- β… **μΉ΄ν…κ³ λ¦¬λ³„ μ λ¦½**: μ¥λ°”κµ¬λ‹ μ£Όλ¬Έ μ‹ κ° μΉ΄ν…κ³ λ¦¬λ§λ‹¤ κ°λ³„ μ λ¦½
- β… **νΈλμ­μ…**: BEGIN/COMMITμΌλ΅ μ›μμ„± λ³΄μ¥

```sql
-- Neon
UPDATE users SET total_points = total_points + ν¬μΈνΈ
WHERE id = user_id;

-- PlanetScale
INSERT INTO user_points (user_id, points, point_type, reason, related_order_id, balance_after)
VALUES (user_id, ν¬μΈνΈ, 'earn', 'μ£Όλ¬Έ μ λ¦½', order_id, μƒμ”μ•΅);
```

### 2. ν¬μΈνΈ νμ (ν™λ¶ μ‹)
**μ„μΉ**: `api/payments/refund.js:362-508` - `deductEarnedPoints()`

- β… **νμ λ΅μ§**:
  1. PlanetScaleμ—μ„ ν•΄λ‹Ή μ£Όλ¬Έ μ λ¦½ λ‚΄μ—­ μ΅°ν
  2. Neonμ—μ„ ν¬μΈνΈ μ°¨κ° (μμ ν—μ©)
  3. PlanetScaleμ— νμ λ‚΄μ—­ μ¶”κ°€ (point_type='refund', μμ)

- β… **μμ μ”μ•΅ ν—μ©**: λ‹¤λ¥Έ μ£Όλ¬Έμ—μ„ μ‚¬μ©λ κ²½μ° λ€μ‘
- β… **μ—λ¬ μ²λ¦¬**: μ‹¤ν¨ μ‹ admin_notifications ν…μ΄λΈ”μ— μ•λ¦Ό

```sql
-- Neon
UPDATE users SET total_points = total_points - μ λ¦½ν¬μΈνΈ
WHERE id = user_id;

-- PlanetScale
INSERT INTO user_points (user_id, points, point_type, reason)
VALUES (user_id, -μ λ¦½ν¬μΈνΈ, 'refund', 'ν™λ¶λ΅ μΈν• νμ');
```

### 3. ν¬μΈνΈ ν™λ¶ (μ‚¬μ© ν¬μΈνΈ λ°ν™)
**μ„μΉ**: `api/payments/refund.js:518-579` - `refundUsedPoints()`

- β… **ν™λ¶ λ΅μ§**:
  1. payments.notesμ—μ„ pointsUsed μ¶”μ¶
  2. Neonμ—μ„ ν¬μΈνΈ μ§€κΈ‰
  3. PlanetScaleμ— ν™λ¶ λ‚΄μ—­ μ¶”κ°€ (point_type='refund', μ–‘μ)

- β… **νΈλμ­μ…**: BEGIN/COMMITμΌλ΅ μ•μ „μ„± λ³΄μ¥

```sql
-- Neon
UPDATE users SET total_points = total_points + μ‚¬μ©ν¬μΈνΈ
WHERE id = user_id;

-- PlanetScale
INSERT INTO user_points (user_id, points, point_type, reason)
VALUES (user_id, μ‚¬μ©ν¬μΈνΈ, 'refund', 'μ£Όλ¬Έ μ·¨μ†λ΅ μΈν• ν™λ¶');
```

### 4. ν¬μΈνΈ λ‚΄μ—­ μ΅°ν
**API**: `GET /api/user/points`

- β… **Dual DB μ΅°ν**:
  - Neon: ν„μ¬ μ΄ ν¬μΈνΈ (users.total_points)
  - PlanetScale: ν¬μΈνΈ λ‚΄μ—­ (user_points)

- β… **λ‚΄μ—­ κµ¬λ¶„**:
  - `point_type = 'earn'`: μ λ¦½ (μ–‘μ, μ΄λ΅μƒ‰)
  - `point_type = 'use'`: μ‚¬μ© (μμ, λΉ¨κ°„μƒ‰)
  - `point_type = 'refund'`: ν™λ¶ (μ–‘μ=ν™λ¶/μμ=νμ, νλ€μƒ‰/μ£Όν™©μƒ‰)

---

## π“ μΆ…ν•© κ²°κ³Ό

### 1. λ²¤λ”/ννΈλ„ λ¶„λ¦¬
π‰ **μ™„λ²½ν• λ¶„λ¦¬ λ‹¬μ„±**
- μƒν’κ΄€λ¦¬: partner_id=NULL, stay/rentcar μ μ™Έ
- ννΈλ„κ΄€λ¦¬: partners ν…μ΄λΈ” (status='pending')λ§ μ΅°ν
- μ™λ°•κ΄€λ¦¬: partners (partner_type='lodging') λ³„λ„
- λ νΈμΉ΄κ΄€λ¦¬: rentcar_vendors ν…μ΄λΈ” μ™„μ „ λ³„λ„

### 2. ν™λ¶ μ‹μ¤ν…
π‰ **8κ° μΉ΄ν…κ³ λ¦¬ λ¨λ‘ μ™„λ²½ μ§€μ›**
- λ§μ΄νμ΄μ§€: μ‚¬μ©μ ν™λ¶ μ”μ²­ β…
- λ²¤λ” λ€μ‹λ³΄λ“: ν™λ¶ λ‚΄μ—­ μ΅°ν (read-only) β…
- κ΄€λ¦¬μ νμ΄μ§€: ν™λ¶ μ²λ¦¬ + μ •μ±… λ¬΄μ‹ β…
- μ¬κ³  λ³µκµ¬: μµμ…/μƒν’/μ—°λ Ήλ³„ ν‹°μΌ“ β…
- μΏ ν° λ³µκµ¬: used_count κ°μ† β…

### 3. ν¬μΈνΈ μ‹μ¤ν…
π‰ **μ™„λ²½ν• Dual DB λ™κΈ°ν™”**
- μ λ¦½: κ²°μ  μ‹ 2% μλ™ μ λ¦½ β…
- νμ: ν™λ¶ μ‹ μ λ¦½ ν¬μΈνΈ μ°¨κ° β…
- ν™λ¶: μ‚¬μ© ν¬μΈνΈ λλ ¤μ¤ β…
- λ‚΄μ—­: λ¨λ“  κ±°λ κΈ°λ΅ μ™„λ²½ μ¶”μ  β…
- νΈλμ­μ…: μ›μμ„± λ³΄μ¥ β…

---

## π”’ μ•μ „μ„± κ²€μ¦

### Toss Payments ν™λ¶ μμ„
1. **Toss API νΈμ¶ λ¨Όμ €** (lines 763-781)
2. **μ„±κ³µ ν›„ DB νΈλμ­μ… μ‹μ‘** (line 785)
3. **μ¬κ³ /ν¬μΈνΈ/μƒνƒ λ³€κ²½** (lines 787-1031)
4. **νΈλμ­μ… μ»¤λ°‹** (line 1033)

**μ¥μ **: Toss ν™λ¶ μ‹¤ν¨ μ‹ DB λ³€κ²½ μ—†μ (μ•μ „)

**λ‹¨μ  λ€μ‘**: Toss μ„±κ³µ ν›„ DB μ‹¤ν¨ μ‹ admin_notificationsμ— μ•λ¦Ό μ €μ¥

### λ™μ‹μ„± μ μ–΄
- β… `FOR UPDATE` λ½ (μΏ ν°, ν¬μΈνΈ)
- β… νΈλμ­μ… (BEGIN/COMMIT/ROLLBACK)
- β… Lock Manager (μμ•½ μƒμ„± μ‹)

---

## π“ μƒμ„±λ κ²€μ¦ μ¤ν¬λ¦½νΈ

1. **verify-vendor-partner-separation.cjs**
   - λ²¤λ”/ννΈλ„ μ™„μ „ λ¶„λ¦¬ κ²€μ¦
   - ν¬λ΅μ¤ μ²΄ν¬ μν–‰
   - μ‹¤μ‹κ°„ DB μƒνƒ ν™•μΈ

2. **check-all-categories-products.cjs**
   - 8κ° μΉ΄ν…κ³ λ¦¬λ³„ μƒν’ ν„ν™©
   - νμ—… μΉ΄ν…κ³ λ¦¬ μƒμ„Έ λ¶„μ„
   - μ™λ°•/λ νΈμΉ΄ λ²¤λ” ν„ν™©

3. **create-tourist-product.cjs**
   - κ΄€κ΄‘μ§€ μΉ΄ν…κ³ λ¦¬ μƒν’ μ¶”κ°€
   - μ¦λ„ νƒν‰μ—Όμ „ μ†κΈλ°•λ¬Όκ΄€ μƒμ„±

---

## β… μµμΆ… κ²°λ΅ 

### λ¨λ“  μ‹μ¤ν… μ •μƒ μ‘λ™ ν™•μΈ
- β… λ²¤λ”/ννΈλ„ μ™„μ „ λ¶„λ¦¬
- β… 8κ° μΉ΄ν…κ³ λ¦¬ ν™λ¶ μ‹μ¤ν… μ™„λ²½
- β… ν¬μΈνΈ μ λ¦½/νμ/ν™λ¶ μ™„λ²½
- β… λ§μ΄νμ΄μ§€/λ²¤λ”/κ΄€λ¦¬μ ν™λ¶ κΈ°λ¥ μ™„λ²½
- β… Dual DB λ™κΈ°ν™” μ™„λ²½
- β… νΈλμ­μ… μ•μ „μ„± ν™•λ³΄
- β… μ¬κ³ /μΏ ν° λ³µκµ¬ μ™„λ²½

### κ²€μ¦ μ†μ” μ‹κ°„
- Stage 1 (λ²¤λ”/ννΈλ„ λ¶„λ¦¬): 10λ¶„
- Stage 2 (λ§μ΄νμ΄μ§€ ν™λ¶): 15λ¶„
- Stage 3 (λ²¤λ” λ€μ‹λ³΄λ“ ν™λ¶): 10λ¶„
- Stage 4 (κ΄€λ¦¬μ ν™λ¶): 10λ¶„
- Stage 5 (ν¬μΈνΈ μ‹μ¤ν…): 5λ¶„
- **μ΄ 50λ¶„** β…

---

**κ²€μ¦ μ™„λ£ μΌμ‹**: 2025-11-17
**κ²€μ¦μ**: Claude Code
**κ²°κ³Ό**: π‰ **μ „μ²΄ μ‹μ¤ν… μ™„λ²½ μ‘λ™!**
