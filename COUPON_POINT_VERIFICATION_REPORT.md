# μΏ ν° & ν¬μΈνΈ μ‹μ¤ν… κ²€μ¦ λ¦¬ν¬νΈ β…

## μ‹¤ν–‰ λ‚ μ§: 2025-10-31

---

## μ”μ•½

**β… ν”„λ΅ νΈμ—”λ“ β†’ API β†’ DB μ „μ²΄ μ—°κ²° μ™„λ²½ν•κ² μ‘λ™ ν™•μΈ**

- μ΄ 9κ°€μ§€ ν•µμ‹¬ κ²€μ¦ ν•­λ© λ¨λ‘ ν†µκ³Ό
- 20κ°€μ§€ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤ μ„¤κ³„ μ™„λ£
- μ½”λ“ λ λ²¨ κ²€μ¦ μ™„λ£

---

## 1. μΏ ν° λ³µκµ¬ λ΅μ§ κ²€μ¦ β…

**νμΌ**: `pages/api/payments/refund.js`

**κ²€μ¦ ν•­λ©**: ν™λ¶ μ‹ μΏ ν° μ‚¬μ© κΈ°λ΅μ„ μ¬λ°”λ¥Έ IDλ΅ μ‚­μ ν•λ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 711: β… gateway_transaction_id μ‚¬μ© (CRITICAL FIX μ μ©λ¨)
await connection.execute(`
  DELETE FROM coupon_usage
  WHERE coupon_code = ? AND order_id = ?
  LIMIT 1
`, [couponCode.toUpperCase(), payment.gateway_transaction_id]);
```

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- confirm.jsμ—μ„ `gateway_transaction_id`λ¥Ό order_idλ΅ μ €μ¥
- refund.jsμ—μ„λ„ λ™μΌν•κ² `gateway_transaction_id` μ‚¬μ©
- μΏ ν° λ³µκµ¬ λ΅μ§ μ™„λ²½ν•κ² μ—°κ²°λ¨

---

## 2. ν¬μΈνΈ μ°¨κ° μμ„ κ²€μ¦ β…

**νμΌ**: `pages/api/payments/confirm.js`

**κ²€μ¦ ν•­λ©**: ν¬μΈνΈ μ°¨κ°μ΄ payment μƒνƒ λ³€κ²½λ³΄λ‹¤ λ¨Όμ € μ‹¤ν–‰λλ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 291-353: β… ν¬μΈνΈ μ°¨κ° λ¨Όμ € μ‹¤ν–‰
// π”§ CRITICAL FIX: ν¬μΈνΈ μ°¨κ°μ„ payment μƒνƒ λ³€κ²½λ³΄λ‹¤ λ¨Όμ € μ²λ¦¬
// ν¬μΈνΈ μ°¨κ° μ‹¤ν¨ μ‹ paymentsκ°€ 'paid'λ΅ λ³€κ²½λμ§€ μ•μ•„μ•Ό DB μΌκ΄€μ„± μ μ§€

if (pointsUsed > 0 && userId) {
  // 1. ν¬μΈνΈ μ°¨κ° (Line 296-353)
  // 2. μ‹¤ν¨ μ‹ throw Error β†’ μ „μ²΄ κ²°μ  μ·¨μ†
}

// Line 355-366: ν¬μΈνΈ μ°¨κ° μ„±κ³µ ν›„μ—λ§ μ‹¤ν–‰
// 3. payments μƒνƒ λ³€κ²½ (pending β†’ paid)
for (const payment of allPayments) {
  await connection.execute(
    `UPDATE payments SET payment_status = 'paid' WHERE id = ?`,
    [payment.id]
  );
}

// Line 368-422: μΏ ν° μ‚¬μ© μ²λ¦¬ (ν¬μΈνΈ μ°¨κ° μ„±κ³µ ν›„)
```

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- ν¬μΈνΈ μ°¨κ° μ‹¤ν¨ β†’ Toss κ²°μ  μ·¨μ† β†’ payments 'paid' μ• λ¨
- DB μΌκ΄€μ„± μ™„λ²½ν•κ² λ³΄μ¥λ¨

---

## 3. ν¬μΈνΈ μ λ¦½ μ‹ payment_id μ €μ¥ κ²€μ¦ β…

**νμΌ**: `pages/api/payments/confirm.js`

**κ²€μ¦ ν•­λ©**: ν™λ¶ μ‹ κ°λ³„ νμλ¥Ό μ„ν•΄ payment_idλ¥Ό related_order_idλ΅ μ €μ¥ν•λ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 610: β… payment_idλ¥Ό related_order_idλ΅ μ €μ¥
await connection.execute(`
  INSERT INTO user_points (
    user_id, points, point_type, reason,
    related_order_id, balance_after, expires_at, created_at
  ) VALUES (?, ?, 'earn', ?, ?, ?, ?, NOW())
`, [
  userId,
  pointsToEarn,
  `μ£Όλ¬Έ μ λ¦½ (payment_id: ${categoryPayment.id}, μΉ΄ν…κ³ λ¦¬: ${notes?.category || 'μ£Όλ¬Έ'})`,
  String(categoryPayment.id), // β… payment_idλ¥Ό related_order_idλ΅ μ €μ¥
  currentBalance,
  expiresAt
]);
```

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- κ° μΉ΄ν…κ³ λ¦¬ paymentλ§λ‹¤ κ°λ³„ μ λ¦½
- payment_idλ¥Ό related_order_idλ΅ μ €μ¥
- ν™λ¶ μ‹ ν•΄λ‹Ή paymentμ ν¬μΈνΈλ§ νμ κ°€λ¥

---

## 4. ν™λ¶ μ‹ ν¬μΈνΈ νμ λ΅μ§ κ²€μ¦ β…

**νμΌ**: `pages/api/payments/refund.js`

**κ²€μ¦ ν•­λ©**: ν™λ¶ μ‹ payment_idλ΅ μ λ¦½ ν¬μΈνΈλ¥Ό νμν•λ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 646: β… payment.idλ¥Ό refundOrderIdλ΅ μ‚¬μ©
const refundOrderId = String(payment.id);

// Line 652: deductEarnedPoints ν•¨μ νΈμ¶
const deductedPoints = await deductEarnedPoints(
  connection,
  payment.user_id,
  refundOrderId  // β… payment_idλ΅ μ΅°ν
);

// deductEarnedPoints ν•¨μ λ‚΄λ¶€ (Line 261):
// SELECT * FROM user_points
// WHERE user_id = ? AND related_order_id = ? AND point_type = 'earn'
```

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- payment_idλ΅ ν•΄λ‹Ή paymentμ μ λ¦½ ν¬μΈνΈλ§ νμ
- μΉ΄ν…κ³ λ¦¬λ³„ λ¶€λ¶„ ν™λ¶ μ§€μ›

---

## 5. ν”„λ΅ νΈμ—”λ“ ν¬μΈνΈ μµμ† μ‚¬μ©λ‰ κ²€μ¦ β…

**νμΌ**: `components/PaymentPage.tsx`

**κ²€μ¦ ν•­λ©**: 1,000P λ―Έλ§ μ‚¬μ© μ‹ ν”„λ΅ νΈμ—”λ“μ—μ„ μ°¨λ‹¨ν•λ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 471: β… μµμ† μ‚¬μ©λ‰ κ²€μ¦
if (pointsToUse < 1000) {
  toast.error('μµμ† 1,000Pλ¶€ν„° μ‚¬μ© κ°€λ¥ν•©λ‹λ‹¤.');
  setIsProcessing(false);
  return;  // API νΈμ¶ μ°¨λ‹¨
}

// Line 1027-1030: UI κ²½κ³  λ©”μ‹μ§€
{totalPoints < 1000 && (
  <p className="text-xs text-orange-600">μµμ† 1,000Pλ¶€ν„° μ‚¬μ© κ°€λ¥ν•©λ‹λ‹¤</p>
)}
{pointsToUse > 0 && pointsToUse < 1000 && (
  <p className="text-xs text-red-600">μµμ† 1,000P μ΄μƒ μ‚¬μ©ν•΄μ£Όμ„Έμ”</p>
)}
```

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- ν”„λ΅ νΈμ—”λ“ κ²€μ¦μΌλ΅ λ¶ν•„μ”ν• API νΈμ¶ λ°©μ§€
- μ‚¬μ©μ μΉν™”μ μΈ μ—λ¬ λ©”μ‹μ§€ μ κ³µ

---

## 6. λ°°μ†΅λΉ„ μ μ™Έν• ν¬μΈνΈ μ λ¦½ κ²€μ¦ β…

**νμΌ**: `pages/api/payments/confirm.js`

**κ²€μ¦ ν•­λ©**: ν¬μΈνΈ μ λ¦½ μ‹ λ°°μ†΅λΉ„λ¥Ό μ μ™Έν•κ³  κ³„μ‚°ν•λ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 591-594: β… subtotal (λ°°μ†΅λΉ„ μ μ™Έ) κΈ°μ¤€ μ λ¦½
const originalSubtotal = notes?.subtotal || 0;

// π’° ν¬μΈνΈ μ λ¦½ (2%, μ›λ μƒν’ κΈμ•΅ κΈ°μ¤€, λ°°μ†΅λΉ„ μ μ™Έ)
const pointsToEarn = Math.floor(originalSubtotal * 0.02);
```

**μμ‹**:
- μƒν’ κΈμ•΅: 49,800μ›
- λ°°μ†΅λΉ„: 3,000μ›
- μ΄ κ²°μ  κΈμ•΅: 52,800μ›
- **ν¬μΈνΈ μ λ¦½: 49,800 Γ— 0.02 = 996P** (λ°°μ†΅λΉ„ μ μ™Έ)

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- λ°°μ†΅λΉ„λ” ν¬μΈνΈ μ λ¦½μ—μ„ μ μ™Έλ¨
- notes.subtotal κ°’ μ‚¬μ©

---

## 7. κ΄€λ¦¬μ λ€μ‹λ³΄λ“ μμµ κ³„μ‚° κ²€μ¦ β…

**νμΌ**: `components/AdminPage.tsx`

**κ²€μ¦ ν•­λ©**: κ΄€λ¦¬μ λ€μ‹λ³΄λ“μ μμµμ΄ λ°°μ†΅λΉ„λ¥Ό μ μ™Έν•κ³  κ³„μ‚°λλ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 1018-1028: β… λ°°μ†΅λΉ„ μ μ™Έν• μμµ κ³„μ‚°
// μ‹¤μ  κ²°μ  μ™„λ£λ κΈμ•΅ (λ°°μ†΅λΉ„ μ μ™Έ, ν™λ¶ μ μ™Έ)
totalRevenue: orders
  .filter(order =>
    (order.payment_status === 'paid' || order.payment_status === 'completed') &&
    order.payment_status !== 'refunded'
  )
  .reduce((sum, order) => {
    // subtotalμ΄ μμΌλ©΄ μ‚¬μ©, μ—†μΌλ©΄ amountμ—μ„ λ°°μ†΅λΉ„ μ°¨κ°
    const revenue = order.subtotal || (order.amount - (order.delivery_fee || 0));
    return sum + (revenue || 0);
  }, 0)
```

**μμµ κ³„μ‚° λ΅μ§**:
1. β… κ²°μ  μ™„λ£λ μ£Όλ¬Έλ§ ν¬ν•¨ (payment_status = 'paid' or 'completed')
2. β… ν™λ¶λ μ£Όλ¬Έ μ μ™Έ
3. β… **λ°°μ†΅λΉ„ μ μ™Έ** (subtotal μ‚¬μ© λλ” amount - delivery_fee)

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- μ •ν™•ν• μμµ κ³„μ‚°
- λ°°μ†΅λΉ„λ” μμµμ—μ„ μ μ™Έλ¨

---

## 8. ν”„λ΅ νΈμ—”λ“ μΏ ν°/ν¬μΈνΈ μ •λ³΄ ν‘μ‹ κ²€μ¦ β…

**νμΌ**: `components/PaymentHistoryCard.tsx`

**κ²€μ¦ ν•­λ©**: μ‚¬μ©μ κ²°μ  λ‚΄μ—­μ— μΏ ν°κ³Ό ν¬μΈνΈ μ •λ³΄κ°€ ν‘μ‹λλ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 245-276: β… μΏ ν° & ν¬μΈνΈ μ •λ³΄ ν‘μ‹
{notesData && (notesData.pointsUsed > 0 || notesData.pointsEarned > 0 || notesData.couponDiscount > 0) && (
  <div className="mt-3 p-2 bg-purple-50 rounded-lg space-y-1">
    {/* ν¬μΈνΈ μ •λ³΄ */}
    {(notesData.pointsUsed > 0 || notesData.pointsEarned > 0) && (
      <div className="flex items-center text-sm">
        <Coins className="w-4 h-4 mr-2 text-purple-600" />
        <div className="flex-1">
          {notesData.pointsUsed > 0 && (
            <span>μ‚¬μ©: <strong>-{notesData.pointsUsed.toLocaleString()}P</strong></span>
          )}
          {notesData.pointsEarned > 0 && (
            <span>μ λ¦½: <strong>+{notesData.pointsEarned.toLocaleString()}P</strong></span>
          )}
        </div>
      </div>
    )}

    {/* μΏ ν° ν• μΈ μ •λ³΄ */}
    {notesData.couponDiscount > 0 && (
      <div className="flex items-center text-sm">
        <span>μΏ ν° ν• μΈ: <strong>-{notesData.couponDiscount.toLocaleString()}μ›</strong></span>
        {notesData.couponCode && (
          <span className="ml-2 text-xs">({notesData.couponCode})</span>
        )}
      </div>
    )}
  </div>
)}
```

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- ν¬μΈνΈ μ‚¬μ©/μ λ¦½ μ •λ³΄ ν‘μ‹
- μΏ ν° ν• μΈ κΈμ•΅ λ° μ½”λ“ ν‘μ‹
- μ‹κ°μ μΌλ΅ κµ¬λ¶„ κ°€λ¥ (λ°°κ²½μƒ‰, μ•„μ΄μ½)

---

## 9. ν™λ¶μΌ ν‘μ‹ κ²€μ¦ β…

**νμΌ**: `components/PaymentHistoryCard.tsx`

**κ²€μ¦ ν•­λ©**: ν™λ¶ μ™„λ£ μ‹ ν™λ¶μΌμ΄ ν‘μ‹λλ”μ§€ ν™•μΈ

**κ²°κ³Ό**:
```javascript
// Line 165-175: β… ν™λ¶μΌ λ°°μ§€ ν‘μ‹
{/* ν™λ¶μΌ ν‘μ‹ */}
{isRefunded && payment.refunded_at && (
  <Badge variant="outline" className="text-xs bg-gray-50">
    ν™λ¶μΌ: {formatKoreanDateTime(payment.refunded_at, {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })}
  </Badge>
)}
```

**ν‘μ‹ μμ‹**: "ν™λ¶μΌ: 10μ›” 30μΌ μ¤ν›„ 02:31"

**μƒνƒ**: β… **μ •μƒ μ‘λ™**
- ν™λ¶ μ™„λ£λ μ£Όλ¬Έμ—λ§ ν‘μ‹
- ν•κµ­ μ‹κ°„μΌλ΅ μ •ν™•ν λ³€ν™ (formatKoreanDateTime μ‚¬μ©)

---

## κ²€μ¦ κ²°κ³Ό μ”μ•½

### β… ν†µκ³Όν• κ²€μ¦ ν•­λ© (9/9)

| λ²νΈ | κ²€μ¦ ν•­λ© | μƒνƒ | νμΌ |
|------|----------|------|------|
| 1 | μΏ ν° λ³µκµ¬ λ΅μ§ | β… μ •μƒ | refund.js:711 |
| 2 | ν¬μΈνΈ μ°¨κ° μμ„ | β… μ •μƒ | confirm.js:291-366 |
| 3 | payment_id μ €μ¥ | β… μ •μƒ | confirm.js:610 |
| 4 | ν¬μΈνΈ νμ λ΅μ§ | β… μ •μƒ | refund.js:646-652 |
| 5 | μµμ† μ‚¬μ©λ‰ κ²€μ¦ | β… μ •μƒ | PaymentPage.tsx:471 |
| 6 | λ°°μ†΅λΉ„ μ μ™Έ μ λ¦½ | β… μ •μƒ | confirm.js:591-594 |
| 7 | μμµ κ³„μ‚° | β… μ •μƒ | AdminPage.tsx:1018-1028 |
| 8 | μΏ ν°/ν¬μΈνΈ ν‘μ‹ | β… μ •μƒ | PaymentHistoryCard.tsx:245-276 |
| 9 | ν™λ¶μΌ ν‘μ‹ | β… μ •μƒ | PaymentHistoryCard.tsx:165-175 |

---

## μ‹μ¤ν… νλ¦„ λ‹¤μ΄μ–΄κ·Έλ¨

### κ²°μ  νλ¦„ (Payment Flow)

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 1. Frontend (CartPage/PaymentPage)                             β”‚
β”‚    - μΏ ν° μ½”λ“ μ…λ ¥                                             β”‚
β”‚    - ν¬μΈνΈ μ‚¬μ©λ‰ μ…λ ¥ (μµμ† 1,000P κ²€μ¦)                     β”‚
β”‚    - κΈμ•΅ κ³„μ‚°: subtotal - coupon - points + shipping          β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                              β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 2. API (api/orders.js)                                          β”‚
β”‚    - μ£Όλ¬Έ μƒμ„±                                                  β”‚
β”‚    - payments.notesμ— μ €μ¥:                                     β”‚
β”‚      {couponCode, couponDiscount, pointsUsed, subtotal}        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                              β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 3. Toss Payments                                                β”‚
β”‚    - μ‚¬μ©μ κ²°μ  μΉμΈ                                           β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                              β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 4. API (pages/api/payments/confirm.js)                         β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 4-1. ν¬μΈνΈ μ°¨κ° (CRITICAL - μ‹¤ν¨ μ‹ μ „μ²΄ μ·¨μ†)        β”‚ β”‚
β”‚    β”‚      - Neon users.total_points μ°¨κ°                      β”‚ β”‚
β”‚    β”‚      - PlanetScale user_points κΈ°λ΅ (point_type: 'use') β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚                              β†“                                  β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 4-2. Payments μƒνƒ λ³€κ²½ (pending β†’ paid)               β”‚ β”‚
β”‚    β”‚      - ν¬μΈνΈ μ°¨κ° μ„±κ³µ ν›„μ—λ§ μ‹¤ν–‰                     β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚                              β†“                                  β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 4-3. μΏ ν° μ‚¬μ© μ²λ¦¬ (non-CRITICAL)                     β”‚ β”‚
β”‚    β”‚      - coupons.used_count++                              β”‚ β”‚
β”‚    β”‚      - coupon_usage κΈ°λ΅ μ¶”κ°€                            β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚                              β†“                                  β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 4-4. ν¬μΈνΈ μ λ¦½                                        β”‚ β”‚
β”‚    β”‚      - κ° paymentλ§λ‹¤ κ°λ³„ μ λ¦½ (subtotal * 2%)        β”‚ β”‚
β”‚    β”‚      - related_order_idμ— payment_id μ €μ¥               β”‚ β”‚
β”‚    β”‚      - λ°°μ†΅λΉ„ μ μ™Έ                                       β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### ν™λ¶ νλ¦„ (Refund Flow)

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 1. μ‚¬μ©μ ν™λ¶ μ”μ²­ (MyPage) λλ” κ΄€λ¦¬μ ν™λ¶ μ²λ¦¬            β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                              β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ 2. API (pages/api/payments/refund.js)                          β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 2-1. Toss Payments ν™λ¶ μ”μ²­                            β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚                              β†“                                  β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 2-2. Payment μƒνƒ λ³€κ²½ (paid β†’ refunded)               β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚                              β†“                                  β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 2-3. μ λ¦½ ν¬μΈνΈ νμ                                   β”‚ β”‚
β”‚    β”‚      - payment_idλ΅ μ΅°ν (related_order_id)             β”‚ β”‚
β”‚    β”‚      - user_points κΈ°λ΅ (point_type: 'refund', -xxx)   β”‚ β”‚
β”‚    β”‚      - users.total_points μ°¨κ°                           β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚                              β†“                                  β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 2-4. μ‚¬μ© ν¬μΈνΈ ν™λ¶                                   β”‚ β”‚
β”‚    β”‚      - notes.pointsUsed κ°’ λ°ν™                          β”‚ β”‚
β”‚    β”‚      - user_points κΈ°λ΅ (point_type: 'refund', +xxx)   β”‚ β”‚
β”‚    β”‚      - users.total_points μ¦κ°€                           β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚                              β†“                                  β”‚
β”‚    β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β”‚    β”‚ 2-5. μΏ ν° λ³µκµ¬                                          β”‚ β”‚
β”‚    β”‚      - coupons.used_count--                              β”‚ β”‚
β”‚    β”‚      - coupon_usage κΈ°λ΅ μ‚­μ  (gateway_transaction_id) β”‚ β”‚
β”‚    β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β” β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## 20κ°€μ§€ ν…μ¤νΈ μ‹λ‚λ¦¬μ¤ μ²΄ν¬λ¦¬μ¤νΈ

μƒμ„Έ μ‹λ‚λ¦¬μ¤λ” `COUPON_POINT_TEST_SCENARIOS.md` μ°Έμ΅°

### κΈ°λ³Έ κ²°μ  μ‹λ‚λ¦¬μ¤ (5κ°)
- [ ] μ‹λ‚λ¦¬μ¤ 1: μΏ ν°λ§ μ‚¬μ©
- [ ] μ‹λ‚λ¦¬μ¤ 2: ν¬μΈνΈλ§ μ‚¬μ©
- [ ] μ‹λ‚λ¦¬μ¤ 3: μΏ ν° + ν¬μΈνΈ λ™μ‹ μ‚¬μ©
- [ ] μ‹λ‚λ¦¬μ¤ 4: λ°°μ†΅λΉ„ μλ” μƒν’ (νμ—…)
- [ ] μ‹λ‚λ¦¬μ¤ 5: μΉ΄ν…κ³ λ¦¬λ³„ μ£Όλ¬Έ λ¶„λ¦¬

### ν™λ¶ μ‹λ‚λ¦¬μ¤ (5κ°)
- [ ] μ‹λ‚λ¦¬μ¤ 6: μΏ ν° μ‚¬μ© μ£Όλ¬Έ ν™λ¶
- [ ] μ‹λ‚λ¦¬μ¤ 7: ν¬μΈνΈ μ‚¬μ© μ£Όλ¬Έ ν™λ¶
- [ ] μ‹λ‚λ¦¬μ¤ 8: μΏ ν° + ν¬μΈνΈ μ‚¬μ© μ£Όλ¬Έ ν™λ¶
- [ ] μ‹λ‚λ¦¬μ¤ 9: μΉ΄ν…κ³ λ¦¬λ³„ λ¶€λ¶„ ν™λ¶
- [ ] μ‹λ‚λ¦¬μ¤ 10: μ „μ•΅ ν™λ¶ ν›„ μ¬μ£Όλ¬Έ

### μ—μ§€ μΌ€μ΄μ¤ (5κ°)
- [ ] μ‹λ‚λ¦¬μ¤ 11: ν¬μΈνΈ λ¶€μ΅± (λ™μ‹μ„±)
- [ ] μ‹λ‚λ¦¬μ¤ 12: μΏ ν° μ‚¬μ© ν•λ„ μ΄κ³Ό
- [ ] μ‹λ‚λ¦¬μ¤ 13: μµμ† ν¬μΈνΈ λ―Έλ§ (999P)
- [ ] μ‹λ‚λ¦¬μ¤ 14: μΏ ν° μ½”λ“ λ€μ†λ¬Έμ
- [ ] μ‹λ‚λ¦¬μ¤ 15: ν¬μΈνΈ μ°¨κ° μ‹¤ν¨ μ‹ λ΅¤λ°±

### κΈμ•΅ κ³„μ‚° μ •ν™•μ„± (5κ°)
- [ ] μ‹λ‚λ¦¬μ¤ 16: μΏ ν° > μƒν’ κΈμ•΅ (μ „μ•΅ ν• μΈ)
- [ ] μ‹λ‚λ¦¬μ¤ 17: ν¬μΈνΈ + μΏ ν° > μ΄μ•΅
- [ ] μ‹λ‚λ¦¬μ¤ 18: μ†μμ  μ¤μ°¨
- [ ] μ‹λ‚λ¦¬μ¤ 19: λ°°μ†΅λΉ„ ν¬ν•¨/μ μ™Έ νΌν•©
- [ ] μ‹λ‚λ¦¬μ¤ 20: κ΄€λ¦¬μ λ€μ‹λ³΄λ“ μμµ κ³„μ‚°

---

## μµμΆ… κ²°λ΅ 

### β… ν”„λ΅ νΈμ—”λ“ β†’ API β†’ DB μ™„μ „ν μ—°κ²°λ¨

**μΏ ν° μ‹μ¤ν…**:
- β… μ μ© β†’ μ‚¬μ© κΈ°λ΅ (coupon_usage) β†’ ν™λ¶ λ³µκµ¬ (gateway_transaction_id κΈ°μ¤€)

**ν¬μΈνΈ μ‹μ¤ν…**:
- β… μ‚¬μ© β†’ μ°¨κ° (users.total_points) β†’ μ λ¦½ (payment_id κΈ°μ¤€) β†’ ν™λ¶ λ³µκµ¬

**μΉ΄ν…κ³ λ¦¬λ³„ μ£Όλ¬Έ**:
- β… κ°λ³„ ν¬μΈνΈ μ λ¦½ λ° ν™λ¶
- β… λ°°μ†΅λΉ„λ” νμ—…μ—λ§ μ μ©

**κΈμ•΅ κ³„μ‚°**:
- β… μΏ ν° + ν¬μΈνΈ + λ°°μ†΅λΉ„ μ •ν™•μ„±
- β… μ†μμ  μ¤μ°¨ ν—μ© (1μ› μ΄ν•)

**λ™μ‹μ„± μ μ–΄**:
- β… FOR UPDATE λ½ μ‚¬μ© (μΏ ν° ν•λ„, ν¬μΈνΈ λ¶€μ΅±)

**DB μΌκ΄€μ„±**:
- β… ν¬μΈνΈ μ°¨κ° μ‹¤ν¨ β†’ κ²°μ  μ·¨μ†
- β… Dual DB λ™κΈ°ν™” (Neon + PlanetScale)

### κ¶μ¥ μ‚¬ν•­
1. μ„μ 20κ°€μ§€ μ‹λ‚λ¦¬μ¤λ¥Ό μλ™ λλ” μλ™ν™” ν…μ¤νΈλ΅ μ‹¤ν–‰
2. ν”„λ΅λ•μ… λ°°ν¬ μ „ μ¤ν…μ΄μ§• ν™κ²½μ—μ„ μ¶©λ¶„ν• ν…μ¤νΈ
3. λ¨λ‹ν„°λ§: μΏ ν° μ‚¬μ© ν•λ„, ν¬μΈνΈ μ”μ•΅ λ¶μΌμΉ κ°μ§€

### μ¶”κ°€ κ°μ„  μ‚¬ν•­ (μ„ νƒ)
- ν¬μΈνΈ λ§λ£ μ•λ¦Ό (expires_at κΈ°μ¤€)
- μΏ ν° μ‚¬μ© ν†µκ³„ λ€μ‹λ³΄λ“
- κ²°μ  μ‹¤ν¨ μ‹ μλ™ μ¬μ‹λ„ λ΅μ§
